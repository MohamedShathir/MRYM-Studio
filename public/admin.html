<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | MRYM Studio</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* --- ADMIN SPECIFIC STYLES --- */
        body { background-color: #f4f6f8; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-card h3 { font-size: 2.5rem; margin-bottom: 5px; color: var(--primary); }
        .stat-card p { color: #666; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }

        /* User Groups */
        .user-group { background: white; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .user-header { background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .user-header:hover { background: #e9ecef; }
        .user-orders { display: none; }
        .user-orders.active { display: block; }

        /* Tables */
        .admin-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .admin-table td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .admin-table tr:last-child td { border-bottom: none; }

        /* Status Buttons */
        .status-btn { 
            padding: 8px 16px; border-radius: 50px; font-size: 0.75rem; font-weight: bold; 
            text-transform: uppercase; cursor: pointer; border: none; transition: 0.2s; color: white; min-width: 110px;
        }
        .status-btn:hover { opacity: 0.9; transform: scale(1.02); }
        .status-btn:active { transform: scale(0.95); }

        /* Status Colors */
        .status-pending { background-color: #6c757d; }
        .status-production { background-color: #fd7e14; }
        .status-delivered { background-color: #28a745; }
        .status-rejected { background-color: #dc3545; }

        /* Controls */
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .filter-select { padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loading-screen" style="height: 100vh; display: flex; justify-content: center; align-items: center; flex-direction: column;">
        <h2 style="color: #33403a;">Verifying Access...</h2>
        <p style="color: #666; margin-top: 10px;">Checking admin permissions</p>
    </div>

    <div id="admin-content" style="display: none;">
        
        <header style="background: white; border-bottom: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <div class="container">
                <nav>
                    <div class="logo">MRYM<span>ADMIN</span></div>
                    <ul class="nav-links">
                        <li><a href="index.html">Back to Site</a></li>
                        <li><button onclick="logoutAdmin()" class="btn-sm" style="border:none; background:none; cursor:pointer; color:#dc3545; font-weight:bold;">Logout</button></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div class="container" style="padding-top: 120px; max-width: 1200px;">
            
            <div class="admin-header">
                <div>
                    <h2>Dashboard</h2>
                    <p style="color:#666;">Overview of custom 3D printing orders</p>
                </div>
                <select id="time-filter" class="filter-select">
                    <option value="all">All Time</option>
                    <option value="month">This Month</option>
                    <option value="week">This Week</option>
                </select>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="stat-total">0</h3>
                    <p>Total Orders</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-production" style="color:#fd7e14;">0</h3>
                    <p>In Production</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-delivered" style="color:#28a745;">0</h3>
                    <p>Delivered</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-rejected" style="color:#dc3545;">0</h3>
                    <p>Rejected</p>
                </div>
            </div>

            <div id="orders-container">
                <p style="text-align:center; padding: 40px; color:#666;">Loading orders...</p>
            </div>

        </div>
    </div>

    <script type="module">
        import { db, auth } from "./js/firebase-config.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, getDocs, orderBy, query, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let allOrders = [];

        // --- 1. SECURITY CHECK ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html"; // Redirect if not logged in
                return;
            }

            try {
                // Check Firestore for 'isAdmin' flag
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists() && userSnap.data().isAdmin === true) {
                    // SUCCESS: Hide Loading, Show Dashboard
                    console.log("Admin Verified: " + user.email);
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('admin-content').style.display = 'block';
                    
                    // Fetch Data
                    await fetchOrders();
                } else {
                    // FAIL: Not an admin
                    alert("ACCESS DENIED: You do not have admin permissions.");
                    window.location.href = "index.html";
                }
            } catch (error) {
                console.error("Security Error:", error);
                document.getElementById('loading-screen').innerHTML = `<h3 style="color:red">Security Check Failed: ${error.message}</h3>`;
            }
        });

        // --- 2. LOGOUT ---
        window.logoutAdmin = async function() {
            if(confirm("Log out of Admin Panel?")) {
                await signOut(auth);
                window.location.href = "login.html";
            }
        }

        // --- 3. DATA FETCHING ---
        async function fetchOrders() {
            const container = document.getElementById('orders-container');
            try {
                const q = query(collection(db, "custom_orders"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                
                // Process data
                allOrders = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    dateObj: new Date(doc.data().createdAt)
                }));

                // Initial Render
                renderDashboard('all');

                // Filter Listener
                document.getElementById('time-filter').addEventListener('change', (e) => {
                    renderDashboard(e.target.value);
                });

            } catch (error) {
                container.innerHTML = `<p style="color:red; text-align:center;">Error loading data: ${error.message}</p>`;
            }
        }

        // --- 4. RENDER DASHBOARD (Filter & Group) ---
        function renderDashboard(filterType) {
            const container = document.getElementById('orders-container');
            container.innerHTML = '';

            // Filter by Date
            const now = new Date();
            const filteredOrders = allOrders.filter(order => {
                if (filterType === 'all') return true;
                if (filterType === 'month') return order.dateObj.getMonth() === now.getMonth() && order.dateObj.getFullYear() === now.getFullYear();
                if (filterType === 'week') {
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(now.getDate() - 7);
                    return order.dateObj >= oneWeekAgo;
                }
                return true;
            });

            // Update Stats
            updateStats(filteredOrders);

            // Group by User
            const grouped = {};
            filteredOrders.forEach(order => {
                const uid = order.userId || "guest";
                if (!grouped[uid]) {
                    grouped[uid] = { 
                        name: order.userName || "Unknown User", 
                        email: order.userEmail || "No Email", 
                        orders: [] 
                    };
                }
                grouped[uid].orders.push(order);
            });

            if (Object.keys(grouped).length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:30px;">No orders found.</p>';
                return;
            }

            // Generate HTML for Groups
            Object.keys(grouped).forEach(userId => {
                const user = grouped[userId];
                const groupDiv = document.createElement('div');
                groupDiv.className = 'user-group';
                
                groupDiv.innerHTML = `
                    <div class="user-header" onclick="this.nextElementSibling.classList.toggle('active')">
                        <div>
                            <strong>${user.name}</strong> 
                            <span style="color:#666; font-size:0.9rem; margin-left:5px;">(${user.email})</span>
                        </div>
                        <div>
                            <span style="background:#fff; border:1px solid #ddd; padding:2px 10px; border-radius:12px; font-size:0.8rem; font-weight:bold;">
                                ${user.orders.length} Orders
                            </span> 
                            <span style="font-size:0.8rem; color:#999; margin-left:5px;">â–¼</span>
                        </div>
                    </div>
                    
                    <div class="user-orders active">
                        <table class="admin-table">
                            ${user.orders.map(order => createOrderRow(order)).join('')}
                        </table>
                    </div>
                `;
                container.appendChild(groupDiv);
            });
        }

        // --- 5. HELPER: Create Table Row ---
        function createOrderRow(order) {
            let statusClass = 'status-pending';
            let label = 'Pending';
            
            if (order.status === 'production') { statusClass = 'status-production'; label = 'In Production'; }
            else if (order.status === 'delivered') { statusClass = 'status-delivered'; label = 'Delivered'; }
            else if (order.status === 'rejected') { statusClass = 'status-rejected'; label = 'Rejected'; }

            return `
                <tr>
                    <td style="width:25%;">
                        <strong>${order.projectName}</strong><br>
                        <span style="font-size:0.8rem; color:#888;">${order.dateObj.toLocaleDateString()}</span>
                    </td>
                    <td style="width:20%;">
                        <a href="${order.modelUrl}" target="_blank" style="text-decoration:none; color:#007bff; font-weight:600;">â¬‡ Download STL</a>
                        ${order.referenceImgUrl ? `<br><a href="${order.referenceImgUrl}" target="_blank" style="font-size:0.8rem; color:#666;">ðŸ“· View Ref Image</a>` : ''}
                    </td>
                    <td style="width:30%; color:#555; white-space:pre-wrap;">${order.instructions || "No instructions."}</td>
                    <td style="width:25%; text-align:right;">
                        <button 
                            id="btn-${order.id}" 
                            class="status-btn ${statusClass}" 
                            onclick="window.cycleStatus('${order.id}', '${order.status}')">
                            ${label}
                        </button>
                    </td>
                </tr>
            `;
        }

        // --- 6. UPDATE STATS ---
        function updateStats(orders) {
            document.getElementById('stat-total').textContent = orders.length;
            document.getElementById('stat-production').textContent = orders.filter(o => o.status === 'production').length;
            document.getElementById('stat-delivered').textContent = orders.filter(o => o.status === 'delivered').length;
            document.getElementById('stat-rejected').textContent = orders.filter(o => o.status === 'rejected').length;
        }

        // --- 7. CYCLE STATUS ---
        window.cycleStatus = async function(orderId, currentStatus) {
            let newStatus = 'pending';
            if (!currentStatus || currentStatus === 'pending') newStatus = 'production';
            else if (currentStatus === 'production') newStatus = 'delivered';
            else if (currentStatus === 'delivered') newStatus = 'rejected';
            else if (currentStatus === 'rejected') newStatus = 'pending';

            // Optimistic UI Update
            const btn = document.getElementById(`btn-${orderId}`);
            const originalText = btn.textContent;
            btn.textContent = "...";
            
            try {
                const orderRef = doc(db, "custom_orders", orderId);
                await updateDoc(orderRef, { status: newStatus });
                
                // Update Local Data
                const orderIndex = allOrders.findIndex(o => o.id === orderId);
                if (orderIndex > -1) {
                    allOrders[orderIndex].status = newStatus;
                    const currentFilter = document.getElementById('time-filter').value;
                    renderDashboard(currentFilter);
                }
            } catch (error) {
                alert("Error updating status: " + error.message);
                btn.textContent = originalText;
            }
        };
    </script>
</body>
</html>