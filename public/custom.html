<script type="module">
  import { db, auth } from "./js/firebase-config.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { collection, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // 1. Cloudinary Config (Updated from your screenshots)
  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dmyxbwrvn/upload";
  const UPLOAD_PRESET = "mrym_uploads";

  // 2. Google Script URL (Paste your Web App URL here)
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyN6eCipJDecsJfJBG8ck3FXrh-7-yy6JYSwxRAQd7UkdkhOGXaDrGPfjssXr5kFFmYfg/exec";

  let currentUser = null;

  // Check Login
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
    } else {
      window.location.href = "login.html";
    }
  });

  // Handle Form Submit
  document.getElementById('custom-order-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const btn = e.target.querySelector('button');
    btn.textContent = "Uploading...";
    btn.disabled = true;

    const projectName = document.getElementById('project-name').value;
    const instructions = document.getElementById('instructions').value;
    const file = document.getElementById('stl-file').files[0];
    const refFile = document.getElementById('ref-img').files[0];

    try {
      // A. Upload STL to Cloudinary
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);

      const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
      const data = await res.json();
      const fileUrl = data.secure_url;

      // B. Upload Reference Image (Optional)
      let refUrl = "";
      if (refFile) {
        const refData = new FormData();
        refData.append("file", refFile);
        refData.append("upload_preset", UPLOAD_PRESET);
        const refRes = await fetch(CLOUDINARY_URL, { method: "POST", body: refData });
        const refJson = await refRes.json();
        refUrl = refJson.secure_url;
      }

      // C. Fetch User Phone from Firestore
      // (We need to get the phone number we saved in complete-profile.html)
      let userPhone = "Not Provided";
      const userSnap = await getDoc(doc(db, "users", currentUser.uid));
      if (userSnap.exists() && userSnap.data().phone) {
        userPhone = userSnap.data().phone;
      }

      // D. Save to Firebase Orders
      const orderData = {
        userId: currentUser.uid,
        userName: currentUser.displayName,
        userEmail: currentUser.email,
        userPhone: userPhone, // Added Phone Here
        projectName: projectName,
        instructions: instructions,
        modelUrl: fileUrl,
        referenceImgUrl: refUrl,
        status: "pending",
        createdAt: new Date().toISOString()
      };

      const docRef = await addDoc(collection(db, "custom_orders"), orderData);

      // E. Send to Google Sheets
      const sheetData = { ...orderData, orderId: docRef.id };

      fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(sheetData)
      }).then(() => console.log("Sent to Sheets"));

      alert("Order placed successfully!");
      window.location.href = "index.html";

    } catch (error) {
      console.error(error);
      alert("Error: " + error.message);
      btn.textContent = "Submit Order";
      btn.disabled = false;
    }
  });
</script>